<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-store" />
<title>Quản lý công tác lái xe</title>
<style>
:root{
  --bg:#0b1020; --ink:#e5e7eb; --muted:#9aa3b2; --card:#121936; --line:#263154; --line2:#2b3a6b;
  --ok:#16a34a; --danger:#ef4444; --today:#0f1f52; --past:#0e1433; --header:#172145;
}
body{margin:0;font-family:system-ui,Arial;background:var(--bg);color:var(--ink)}
.wrap{max-width:1280px;margin:0 auto;padding:18px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px;margin-bottom:18px}
table{width:100%;border-collapse:separate;border-spacing:0}
th,td{padding:6px;border-bottom:1px solid var(--line);font-size:13px}
th{font-weight:600;color:#cbd5e1;background:var(--header);text-align:center}
.row{display:flex;align-items:center;gap:6px}
.dot{width:16px;height:16px;border-radius:50%;background:#6b7280}
.dot.going{background:var(--danger)}
.dot.backed{background:var(--ok)}
.week-grid th,.week-grid td{border:1px solid var(--line2);padding:0}
.day-cell{min-width:95px;min-height:96px;padding:2px;background:#0d1431}
.day-cell.today{outline:2px solid #2a3a74}
.cell-wrap{display:grid;grid-template-columns:1fr 1fr}
.cell-half{padding:2px}
.half-title{font-size:10px;color:#a6b0c3}
.line{border:1px dashed var(--line2);border-radius:4px;padding:2px;min-height:12px;margin-bottom:2px;background:#0b1433;font-size:14px}
.driver-tag{font-size:12px;font-weight:700;text-align:center;margin:2px}
.driver-tag.red{color:#ef4444}
.driver-tag.green{color:#16a34a}
</style>
</head>
<body>
<div class="wrap">
<h1>Quản lý công tác lái xe</h1>
<div class="card">
<table><thead><tr><th>Tài xế</th><th>Trạng thái</th><th>Thời điểm đi</th><th>Thời điểm về</th><th>Thời gian vắng</th><th>Thao tác</th></tr></thead>
<tbody id="tbody"></tbody></table>
</div>
<div class="card">
<div id="weekRange"></div>
<table class="week-grid" id="weekTable"></table>
</div>
</div>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
<script>
const DRIVERS=["Đ/c Luận","Đ/c Hiền","Đ/c Trạch","Đ/c Tùng","Đ/c Lê Hùng","Đ/c Nhật","Đ/c Ngọc","Đ/c Chiến","Đ/c Thọ"];
const $=(s,r=document)=>r.querySelector(s);const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
const pad=n=>String(n).padStart(2,"0");
const fmtDate=d=>pad(d.getDate())+"/"+pad(d.getMonth()+1)+"/"+d.getFullYear();
const fmtTime=d=>pad(d.getHours())+":"+pad(d.getMinutes());
const fmtDateTime=d=>fmtTime(d)+" "+fmtDate(d);
const todayStart=()=>{const n=new Date();return new Date(n.getFullYear(),n.getMonth(),n.getDate());}
const ymd=d=>d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate());
let statusMap=new Map();
function calcDuration(start,end){const ms=end-start;if(ms<=0)return"-";const m=Math.floor(ms/60000),h=Math.floor(m/60),mm=m%60;return pad(h)+":"+pad(mm);}
function statusColor(name){const st=statusMap.get(name)||{goAt:null,backAt:null};if(st.goAt&&!st.backAt)return"red";return"green";}
function renderRow(name){let tr=$(`#tbody tr[data-id="${name}"]`);if(!tr){tr=document.createElement("tr");tr.dataset.id=name;
tr.innerHTML=`<td><div class="row"><span class="dot"></span><b>${name}</b></div></td><td class="state"></td><td class="go"></td><td class="back"></td><td class="dur"></td>
<td><button onclick="onGo('${name}')">Đi</button><button onclick="onBack('${name}')">Về</button></td>`;$("#tbody").appendChild(tr);}
const st=statusMap.get(name)||{};const go=st.goAt?new Date(st.goAt):null;const back=st.backAt?new Date(st.backAt):null;
$(".state",tr).textContent=go&&!back?"Đang đi":"Đã về";$(".go",tr).textContent=go?fmtDateTime(go):"-";$(".back",tr).textContent=back?fmtDateTime(back):"-";
$(".dur",tr).textContent=go?calcDuration(go,back||new Date()):"-";const dot=$(".dot",tr);dot.className="dot "+(go&&!back?"going":"backed");}
function onGo(name){statusMap.set(name,{goAt:new Date(),backAt:null});renderRow(name);refreshTags();}
function onBack(name){const cur=statusMap.get(name)||{};statusMap.set(name,{goAt:cur.goAt,backAt:new Date()});renderRow(name);refreshTags();}
function renderWeek(){weekTable.innerHTML="";const mon=new Date();const w=(mon.getDay()+6)%7;mon.setDate(mon.getDate()-w);let trHead=document.createElement("tr");trHead.innerHTML="<th>Ngày</th>"+DRIVERS.map(n=>"<th>"+n+"</th>").join("");weekTable.appendChild(trHead);
for(let i=0;i<7;i++){const d=new Date(mon);d.setDate(mon.getDate()+i);let tr=document.createElement("tr");tr.innerHTML="<td>"+fmtDate(d)+"</td>";DRIVERS.forEach(name=>{const td=document.createElement("td");td.className="day-cell";
const tag=document.createElement("div");tag.className="driver-tag "+statusColor(name);tag.dataset.name=name;tag.textContent=name;td.appendChild(tag);
const wrap=document.createElement("div");wrap.className="cell-wrap";["Sáng","Chiều"].forEach(b=>{const half=document.createElement("div");half.className="cell-half";half.innerHTML="<div class='half-title'>"+b+"</div>";for(let j=0;j<2;j++){const l=document.createElement("div");l.className="line";l.contentEditable=true;half.appendChild(l);}wrap.appendChild(half);});td.appendChild(wrap);tr.appendChild(td);});weekTable.appendChild(tr);}}
function refreshTags(){$$(".driver-tag").forEach(tag=>{const n=tag.dataset.name;tag.classList.remove("red","green");tag.classList.add(statusColor(n));});}
function init(){DRIVERS.forEach(n=>{statusMap.set(n,{goAt:null,backAt:null});renderRow(n);});renderWeek();}
window.onload=init;
</script>
</body></html>