<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Theo dõi đi công tác / về công ty</title>
  <style>
    :root{
      --bg:#0b1020; --card:#121936; --muted:#9aa3b2; --ok:#16a34a; --danger:#ef4444; --ink:#e5e7eb;
      --line:#263154; --btn:#334155; --accent:#2563eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--ink)}
    .wrap{max-width:1000px;margin:0 auto;padding:20px;}
    h1{margin:0 0 6px;font-size:22px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 8px;border-bottom:1px solid var(--line);font-size:14px}
    th{font-weight:600;text-align:left;color:#cbd5e1}
    tr:last-child td{border-bottom:none}
    .row{display:flex;gap:10px;align-items:center}
    .status-dot{width:10px;height:10px;border-radius:999px;background:#6b7280;box-shadow:0 0 0 4px rgba(255,255,255,.03)}
    .status-dot.go{background:var(--danger);box-shadow:0 0 0 4px rgba(239,68,68,.2)}
    .status-dot.back{background:var(--ok);box-shadow:0 0 0 4px rgba(22,163,74,.2)}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer;transition:transform .02s ease-in-out,opacity .15s;display:inline-flex;align-items:center;justify-content:center;gap:8px;color:white}
    .btn:active{transform:translateY(1px)}
    .btn-go{background:var(--danger)}
    .btn-back{background:var(--ok)}
    .btn-muted{background:#42506d}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
    .pill{font-size:12px;color:var(--muted)}
    .right{margin-left:auto}
    .tag{display:inline-flex;align-items:center;gap:6px;background:#0f162f;border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:12px;color:#cbd5e1}
    .clock{font-variant-numeric:tabular-nums}
    .foot{margin-top:10px;color:var(--muted);font-size:12px}
    @media (max-width:720px){ th:nth-child(4),td:nth-child(4), th:nth-child(5),td:nth-child(5){display:none} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>✅ Theo dõi thời gian đi công tác / về công ty</h1>
    <div class="sub">Danh sách 9 tài xế: 1 → 9. Bấm <b>Đi công tác</b> (đỏ) khi rời công ty, bấm <b>Về công ty</b> (xanh) khi đã về.</div>

    <div class="card">
      <div class="toolbar">
        <span class="tag">Ngày: <span id="today" style="margin-left:6px"></span></span>
        <span class="tag clock">Giờ: <span id="now" style="margin-left:6px"></span></span>
        <button id="resetDay" class="btn btn-muted">Xóa dữ liệu hôm nay</button>
        <button id="exportCsv" class="btn btn-muted">Xuất CSV</button>
        <span class="pill right">Dữ liệu lưu cục bộ trên trình duyệt (mỗi thiết bị riêng)</span>
      </div>

      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Trạng thái</th>
            <th>Thời điểm đi</th>
            <th>Thời điểm về</th>
            <th>Thời gian vắng</th>
            <th>Thao tác</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="foot">Mẹo: thêm trang ra màn hình chính trên điện thoại để bấm nhanh.</div>
    </div>
  </div>

  <script>
    // ===== Cấu hình tên tài xế =====
    const DRIVERS = ["1","2","3","4","5","6","7","8","9"]; // có thể đổi thành tên thật sau

    // ===== Helpers =====
    const $ = (s,root=document)=>root.querySelector(s);
    const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
    const pad = n=>String(n).padStart(2,'0');
    const fmtDate = (d)=>`${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
    const fmtTime = (d)=>`${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    const fmtDateTime = (d)=>`${fmtTime(d)} ${fmtDate(d)}`;
    const todayKey = ()=>{
      const n=new Date(); const d=new Date(n.getFullYear(),n.getMonth(),n.getDate());
      return d.toISOString().slice(0,10); // YYYY-MM-DD
    };
    const KEY_PREFIX = ()=>`fleet:${todayKey()}:`;

    function getState(id){
      const raw = localStorage.getItem(KEY_PREFIX()+id);
      return raw? JSON.parse(raw): { goAt:null, backAt:null };
    }
    function setState(id, state){ localStorage.setItem(KEY_PREFIX()+id, JSON.stringify(state)); }

    function durationMs(start, end){ return end - start; }
    function fmtDuration(ms){
      if (ms==null || isNaN(ms) || ms<0) return "-";
      const s=Math.floor(ms/1000);
      const hh=Math.floor(s/3600), mm=Math.floor((s%3600)/60), ss=s%60;
      return `${pad(hh)}:${pad(mm)}:${pad(ss)}`;
    }

    // ===== UI render =====
    const tbody = $("#tbody");
    function renderRow(id){
      const tr = document.createElement('tr');
      tr.dataset.id = id;
      const st = getState(id);
      const goAt = st.goAt? new Date(st.goAt): null;
      const backAt = st.backAt? new Date(st.backAt): null;
      const isOut = !!goAt && !backAt; // đang đi công tác
      const statusClass = isOut? 'go': (backAt? 'back': '');

      tr.innerHTML = `
        <td><div class="row"><div class="status-dot ${statusClass}"></div><b>${id}</b></div></td>
        <td>${ isOut? 'Đang đi công tác' : (backAt? 'Đã về công ty' : 'Chưa đi') }</td>
        <td>${ goAt? escapeHtml(fmtDateTime(goAt)) : '-' }</td>
        <td>${ backAt? escapeHtml(fmtDateTime(backAt)) : '-' }</td>
        <td>${ goAt? fmtDuration(durationMs(goAt, backAt || new Date())) : '-' }</td>
        <td>
          <div class="row">
            <button class="btn btn-go act-go">Đi công tác</button>
            <button class="btn btn-back act-back">Về công ty</button>
          </div>
        </td>`;

      // Gắn sự kiện nút
      $(".act-go", tr).addEventListener('click', ()=> onGo(id));
      $(".act-back", tr).addEventListener('click', ()=> onBack(id));

      return tr;
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]));
    }

    function renderTable(){
      tbody.innerHTML = '';
      DRIVERS.forEach(id=> tbody.appendChild(renderRow(id)) );
    }

    // ===== Hành động =====
    function onGo(id){
      const now = new Date();
      const st = getState(id);
      st.goAt = now.toISOString();
      st.backAt = null; // bắt đầu chuyến mới -> xoá thời điểm về trước đó
      setState(id, st);
      refreshRow(id);
      vibrate();
    }
    function onBack(id){
      const now = new Date();
      const st = getState(id);
      if (!st.goAt){
        // Nếu chưa bấm đi mà bấm về, vẫn lưu thời điểm về
        st.goAt = null;
      }
      st.backAt = now.toISOString();
      setState(id, st);
      refreshRow(id);
      vibrate();
    }

    function refreshRow(id){
      const tr = $$('tr', tbody).find(r=>r.dataset.id===String(id));
      if (!tr) return;
      const st = getState(id);
      const goAt = st.goAt? new Date(st.goAt): null;
      const backAt = st.backAt? new Date(st.backAt): null;
      const isOut = !!goAt && !backAt;

      $(".status-dot", tr).className = `status-dot ${ isOut? 'go': (backAt? 'back': '') }`;
      tr.children[1].textContent = isOut? 'Đang đi công tác' : (backAt? 'Đã về công ty' : 'Chưa đi');
      tr.children[2].textContent = goAt? fmtDateTime(goAt) : '-';
      tr.children[3].textContent = backAt? fmtDateTime(backAt) : '-';
      tr.children[4].textContent = goAt? fmtDuration(durationMs(goAt, backAt || new Date())) : '-';
    }

    function tickDurations(){
      DRIVERS.forEach(id=>{
        const st = getState(id);
        if (st.goAt && !st.backAt) refreshRow(id);
      });
    }

    function resetToday(){
      if (!confirm('Xoá toàn bộ dữ liệu của HÔM NAY trên thiết bị này?')) return;
      const prefix = KEY_PREFIX();
      for (let i = localStorage.length - 1; i >= 0; i--) {
        const k = localStorage.key(i);
        if (k && k.startsWith(prefix)) localStorage.removeItem(k);
      }
      renderTable();
    }

    function exportCsv(){
      const rows = [["Tai_xe","Trang_thai","Thoi_diem_di","Thoi_diem_ve","Thoi_gian_vang(hh:mm:ss)"]];
      DRIVERS.forEach(id=>{
        const st = getState(id);
        const goAt = st.goAt? new Date(st.goAt): null;
        const backAt = st.backAt? new Date(st.backAt): null;
        const state = st.goAt && !st.backAt ? 'Dang_di' : (st.backAt? 'Da_ve' : 'Chua_di');
        rows.push([
          id,
          state,
          goAt? fmtDateTime(goAt) : '',
          backAt? fmtDateTime(backAt) : '',
          st.goAt ? fmtDuration(durationMs(goAt, backAt || new Date())) : ''
        ]);
      });
      const csv = rows.map(r=> r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `theo-doi-${todayKey()}.csv`; a.click();
      setTimeout(()=> URL.revokeObjectURL(url), 2000);
    }

    function vibrate(){ try{ navigator.vibrate && navigator.vibrate(30);}catch(e){} }

    function updateClock(){
      const n=new Date();
      $('#now').textContent = fmtTime(n);
    }

    // ===== Khởi tạo =====
    function init(){
      $('#today').textContent = fmtDate(new Date());
      renderTable();
      $('#resetDay').addEventListener('click', resetToday);
      $('#exportCsv').addEventListener('click', exportCsv);
      setInterval(updateClock, 1000); updateClock();
      setInterval(tickDurations, 1000);
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
