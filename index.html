<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <title>Qu·∫£n l√Ω c√¥ng t√°c l√°i xe</title>
  <style>
    :root{
      --bg:#121014;
      --card:#1d1a22;
      --header:#251f2b;
      --today:#2a2331;
      --past:#3a2a36;
      --line:#4a3c52;
      --line2:#5d4d68;
      --ink:#ffd54f;
      --muted:#ffe599;
      --ok:#16a34a;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1280px;margin:0 auto;padding:18px}
    h1{margin:0 0 10px;font-size:22px}
    .sub{color:var(--muted);font-size:13px;margin:6px 0 14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;margin-bottom:18px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
    .tag{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.04);border:1px solid var(--line);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--ink)}
    .right{margin-left:auto}
    .clock{font-variant-numeric:tabular-nums}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 12px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:8px;color:var(--ink)}
    .btn:active{transform:translateY(1px)}
    .btn-muted{background:#2a2430}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:8px;border-bottom:1px solid var(--line);font-size:14px;vertical-align:top}
    th{font-weight:700;color:var(--ink);text-align:left;background:var(--header);position:sticky;top:0;z-index:1}
    tr:last-child td{border-bottom:none}
    .row{display:flex;gap:8px;align-items:center}
    .dot{width:18px;height:18px;border-radius:999px;background:#6b7280; display:inline-block; overflow:hidden; text-indent:-9999px}
    .dot.going{background:var(--danger)}
    .dot.backed{background:var(--ok)}
    .hide-sm{display:table-cell}
    @media (max-width:780px){ .hide-sm{display:none} }
    /* WEEK GRID */
    .scroll-x{overflow:auto}
    .week-grid{width:100%;border-collapse:separate;border-spacing:0}
    .week-grid th,.week-grid td{border:1px solid var(--line2);padding:0;vertical-align:top}
    .week-grid th{background:var(--header); text-align:center; font-size:13px; font-weight:700; white-space:nowrap;}
    .hdr-sub{display:block; font-size:11px; color:var(--muted); opacity:.9; margin-top:2px}
    .day-head{padding:6px}
    .day-name{font-weight:700}
    .day-date{color:var(--muted)}
    .day-cell{min-width:90px;min-height:96px; padding:4px; background:#211c26}
    .day-cell.past{background:var(--past); font-weight:600; color:var(--ink)}
    .day-cell.today{background:var(--today); outline:2px solid rgba(255,213,79,.25)}
    .cell-wrap{display:grid;grid-template-columns:1fr 1fr;gap:0;border-top:1px dashed rgba(255,213,79,.25)}
    .cell-half{padding:4px}
    .half-title{font-size:10.5px;color:var(--muted);margin:0 0 4px}
    /* NOTE BOX: Enter inserts newline, display with pre-wrap */
    .line{
      border:1px dashed var(--line2);
      border-radius:6px;
      padding:2px 4px;
      min-height:24px;
      min-width:60px;
      max-width:100%;
      display:inline-block;
      background:rgba(0,0,0,.12);
      color:var(--ink);
      font-size:15px;
      line-height:1.5;
      white-space:pre-wrap;   /* show \n as line break */
      word-break:break-word;
      overflow-x:hidden;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
    }
    .line[contenteditable="true"]{outline:none}
    .driver-tag{font-size:12px; font-weight:700; text-align:center; margin:2px 0 2px}
    .driver-tag.red{   color:#ef4444; }
    .driver-tag.green{ color:#16a34a; }
    .col-list{display:flex; flex-direction:column; gap:4px; white-space:nowrap}
    .col-list span{display:inline-block}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üöó Qu·∫£n l√Ω c√¥ng t√°c l√°i xe</h1>
    <div class="sub">B·∫£ng 2: √¥ ghi ch√∫ Enter xu·ªëng d√≤ng; ti√™u ƒë·ªÅ sau t√™n l√°i xe c√≥ <b>/ T2/T3/T4/T5/T6/T7/CN</b>.</div>

    <!-- B·∫£ng 1 (r√∫t g·ªçn v√≠ d·ª•): b·∫°n c√≥ th·ªÉ thay b·∫±ng b·∫£n ƒë·∫ßy ƒë·ªß tr∆∞·ªõc ƒë√¢y -->
    <div class="card">
      <div class="toolbar">
        <span class="tag">H√¥m nay: <b id="today"></b></span>
        <span class="tag clock">Gi·ªù: <span id="now"></span></span>
      </div>
      <table>
        <thead>
          <tr>
            <th>T√™n l√°i xe</th>
            <th>Tr·∫°ng th√°i ho·∫°t ƒë·ªông xe</th>
            <th class="hide-sm">Th·ªùi ƒëi·ªÉm ƒëi</th>
            <th class="hide-sm">Th·ªùi ƒëi·ªÉm v·ªÅ</th>
            <th class="hide-sm">Th·ªùi gian ƒëi c√¥ng t√°c</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- B·∫£ng 2: tu·∫ßn -->
    <div class="card">
      <div class="toolbar">
        <span class="tag">Tu·∫ßn: <b id="weekRange"></b></span>
        <button id="prevWeek" class="btn btn-muted">‚óÄ Tu·∫ßn tr∆∞·ªõc</button>
        <button id="thisWeek" class="btn btn-muted">Tu·∫ßn n√†y</button>
        <button id="nextWeek" class="btn btn-muted">Tu·∫ßn sau ‚ñ∂</button>
        <button id="clearWeek" class="btn btn-muted">X√≥a tr·∫Øng tu·∫ßn (m√°y n√†y)</button>
      </div>
      <div class="scroll-x">
        <table class="week-grid" id="weekTable"></table>
      </div>
    </div>
  </div>

  <script>
    // ===== C·∫•u h√¨nh =====
    const DRIVERS = ["ƒê/c Lu·∫≠n","ƒê/c Hi·ªÅn","ƒê/c Tr·∫°ch","ƒê/c T√πng","ƒê/c L√™ H√πng","ƒê/c Nh·∫≠t","ƒê/c Ng·ªçc","ƒê/c Chi·∫øn","ƒê/c Th·ªç"];

    // ===== Utils =====
    const $ = (s,root=document)=>root.querySelector(s);
    const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));
    const pad = n=>String(n).padStart(2,'0');
    const fmtDate = d=>`${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
    const fmtTime = d=>`${pad(d.getHours())}:${pad(d.getMinutes())}`;
    const fmtDateTime = d=>`${fmtTime(d)} ${fmtDate(d)}`;
    const todayStart = ()=>{ const n=new Date(); return new Date(n.getFullYear(), n.getMonth(), n.getDate()); };
    const ymd = d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const todayKey = ()=> ymd(todayStart());

    // ===== B·∫£ng 1 (ƒë∆°n gi·∫£n) =====
    const tbody = $('#tbody');
    const statusMap = new Map(); // name -> { trips: [{goAt, backAt}] }

    function getLocalStatus(name){
      const raw = localStorage.getItem(`status:${todayKey()}:${name}`);
      return raw? JSON.parse(raw) : {trips: []};
    }
    function setLocalStatus(name, val){
      localStorage.setItem(`status:${todayKey()}:${name}`, JSON.stringify(val));
      statusMap.set(name, val);
      renderRow(name);
    }

    function buildRow(name){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><div class="row"><span class="dot backed"></span><b class="driver"></b></div></td>
        <td class="state">Ch∆∞a ƒëi</td>
        <td class="go-time hide-sm"><div class="col-list"></div></td>
        <td class="back-time hide-sm"><div class="col-list"></div></td>
        <td class="dur-time hide-sm"><div class="col-list"></div></td>
        <td>
          <div class="row">
            <button class="btn btn-muted act-go">ƒêi</button>
            <button class="btn btn-muted act-back">V·ªÅ</button>
          </div>
        </td>`;
      $('.driver', tr).textContent = name;
      $('.act-go', tr).addEventListener('click', ()=> onGo(name));
      $('.act-back', tr).addEventListener('click', ()=> onBack(name));
      return tr;
    }

    function isOutNow(st){
      const trips = st.trips || [];
      return trips.length && trips[trips.length-1].goAt && !trips[trips.length-1].backAt;
    }
    function calcDuration(start, end){
      const ms = end - start;
      if (ms <= 0 || !isFinite(ms)) return '00:00';
      const m = Math.floor(ms/60000), h = Math.floor(m/60), mm = m%60;
      return `${pad(h)}:${pad(mm)}`;
    }

    function renderRow(name){
      const tr = Array.from(tbody.children).find(r => $('.driver', r)?.textContent === name) || buildRow(name);
      if (!tr.isConnected) tbody.appendChild(tr);

      const st = statusMap.get(name) || {trips: []};
      const trips = st.trips || [];
      const dot = $('.dot', tr);
      dot.classList.remove('going','backed');
      if(isOutNow(st)) dot.classList.add('going'); else dot.classList.add('backed');

      $('.state', tr).textContent = isOutNow(st) ? 'ƒêang ƒëi c√¥ng t√°c' : (trips.length ? 'ƒê√£ v·ªÅ c√¥ng ty' : 'Ch∆∞a ƒëi');

      const goCol = $('.go-time .col-list', tr);
      const backCol = $('.back-time .col-list', tr);
      const durCol = $('.dur-time .col-list', tr);
      goCol.innerHTML = backCol.innerHTML = durCol.innerHTML = '';

      trips.forEach(t=>{
        const goAt = t.goAt ? new Date(t.goAt) : null;
        const backAt = t.backAt ? new Date(t.backAt) : null;
        const goSpan = document.createElement('span');
        const backSpan = document.createElement('span');
        const durSpan = document.createElement('span');
        goSpan.textContent = goAt ? fmtDateTime(goAt) : '‚Äî';
        backSpan.textContent = backAt ? fmtDateTime(backAt) : '‚Äî';
        durSpan.textContent = goAt ? calcDuration(goAt, backAt || new Date()) : '‚Äî';
        goCol.appendChild(goSpan);
        backCol.appendChild(backSpan);
        durCol.appendChild(durSpan);
      });

      if (trips.length === 0){
        ['go-time','back-time','dur-time'].forEach(cls=>{
          $(`.${cls} .col-list`, tr).innerHTML = '<span>-</span>';
        });
      }
    }

    function onGo(name){
      const nowIso = new Date().toISOString();
      const st = statusMap.get(name) || {trips: []};
      if (isOutNow(st)) { renderRow(name); return; }
      st.trips.push({goAt: nowIso, backAt: null});
      setLocalStatus(name, st);
    }
    function onBack(name){
      const nowIso = new Date().toISOString();
      const st = statusMap.get(name) || {trips: []};
      if (isOutNow(st)){
        st.trips[st.trips.length-1].backAt = nowIso;
      } else {
        st.trips.push({goAt: null, backAt: nowIso});
      }
      setLocalStatus(name, st);
    }

    function renderTable(){
      tbody.innerHTML = '';
      DRIVERS.forEach(name=>{
        statusMap.set(name, getLocalStatus(name));
        renderRow(name);
      });
    }

    // ===== B·∫£ng 2 (tu·∫ßn) =====
    const weekTable = $('#weekTable');
    const DAYS = ['Th·ª© 2','Th·ª© 3','Th·ª© 4','Th·ª© 5','Th·ª© 6','Th·ª© 7','Ch·ªß nh·∫≠t'];
    function getMonday(d){ const t=new Date(d); const w=(t.getDay()+6)%7; t.setDate(t.getDate()-w); t.setHours(0,0,0,0); return t; }
    let monday = getMonday(new Date());

    function loadCellLocal(driver, date){
      const raw = localStorage.getItem(`week:${ymd(monday)}:${driver}:${ymd(date)}`);
      return raw? JSON.parse(raw) : {am1:'', am2:'', pm1:'', pm2:''};
    }
    function saveCellLocal(driver, date, data){
      localStorage.setItem(`week:${ymd(monday)}:${driver}:${ymd(date)}`, JSON.stringify(data));
    }
    function debounce(fn, delay=250){
      let t; return function(...args){ clearTimeout(t); t=setTimeout(()=>fn.apply(this,args), delay); };
    }

    function renderWeek(){
      weekTable.innerHTML='';
      const sun=new Date(monday); sun.setDate(sun.getDate()+6);
      // header
      const thead = document.createElement('thead');
      const htr = document.createElement('tr');
      const th0 = document.createElement('th'); th0.textContent='Ng√†y'; htr.appendChild(th0);
      DRIVERS.forEach(n=>{ 
        const th=document.createElement('th'); 
        th.innerHTML = `${n}<span class="hdr-sub">/ T2/T3/T4/T5/T6/T7/CN</span>`;
        htr.appendChild(th); 
      });
      thead.appendChild(htr); weekTable.appendChild(thead);

      // body
      const tbodyWeek = document.createElement('tbody');
      for(let i=0;i<7;i++){
        const d = new Date(monday); d.setDate(d.getDate()+i);
        const tr = document.createElement('tr');
        const first = document.createElement('td'); first.innerHTML = `<div class="day-head"><div class="day-name">${DAYS[i]}</div><div class="day-date">${fmtDate(d)}</div></div>`; tr.appendChild(first);

        const isPast = d < todayStart();
        const isToday = ymd(d) === todayKey();

        DRIVERS.forEach(name=>{
          const td = document.createElement('td');
          td.className = `day-cell ${isToday?'today':(isPast?'past':'')}`;

          // T√™n l√°i xe (ch·ªâ ƒë·ªÉ ƒë·ªãnh h∆∞·ªõng, gi·ªØ c·ªë ƒë·ªãnh)
          const driverTag = document.createElement('div');
          driverTag.className = `driver-tag`;
          driverTag.textContent = name;
          td.appendChild(driverTag);

          const wrap = document.createElement('div'); 
          wrap.className = 'cell-wrap';

          const data = loadCellLocal(name, d);

          function buildHalf(title, v1, v2){
            const half = document.createElement('div'); half.className='cell-half';
            half.innerHTML = `<div class="half-title">${title}</div>`;
            const l1 = document.createElement('div'); l1.className='line'; l1.contentEditable=true; l1.textContent=v1||''; half.appendChild(l1);
            const l2 = document.createElement('div'); l2.className='line'; l2.contentEditable=true; l2.textContent=v2||''; half.appendChild(l2);
            return {half, l1, l2};
          }

          const {half:am, l1:am1, l2:am2} = buildHalf('S√°ng', data?.am1, data?.am2);
          const {half:pm, l1:pm1, l2:pm2} = buildHalf('Chi·ªÅu', data?.pm1, data?.pm2);
          wrap.appendChild(am); wrap.appendChild(pm); td.appendChild(wrap); tr.appendChild(td);

          // Save helper
          const saveAll = debounce(()=>{
            const payload = { am1: am1.textContent, am2: am2.textContent, pm1: pm1.textContent, pm2: pm2.textContent };
            saveCellLocal(name, d, payload);
          }, 300);

          // Enter -> newline; support Vietnamese IME
          [am1,am2,pm1,pm2].forEach(el=>{
            el._composing = false;
            el.addEventListener('compositionstart', ()=> el._composing = true);
            el.addEventListener('compositionend',   ()=> { el._composing = false; saveAll(); });
            el.addEventListener('keydown', (e)=>{
              if (e.key === 'Enter'){
                e.preventDefault();
                if (document.queryCommandSupported && document.queryCommandSupported('insertText')) {
                  document.execCommand('insertText', false, '\n');
                } else {
                  const sel = window.getSelection();
                  if (sel && sel.rangeCount){
                    const range = sel.getRangeAt(0);
                    const textNode = document.createTextNode('\n');
                    range.deleteContents();
                    range.insertNode(textNode);
                    range.setStartAfter(textNode);
                    range.setEndAfter(textNode);
                  } else {
                    el.textContent += '\n';
                  }
                }
                saveAll();
              }
            });
            el.addEventListener('input', ()=> { if (!el._composing) saveAll(); });
          });
        });

        tbodyWeek.appendChild(tr);
      }
      weekTable.appendChild(tbodyWeek);

      // range label
      document.getElementById('weekRange').textContent = `${fmtDate(monday)} ‚Üí ${fmtDate((d=>{const x=new Date(d);x.setDate(x.getDate()+6);return x;})(monday))}`;
    }

    // ƒêi·ªÅu khi·ªÉn tu·∫ßn
    document.addEventListener('click', (e)=>{
      if (e.target && e.target.id === 'prevWeek'){ monday.setDate(monday.getDate()-7); renderWeek(); }
      if (e.target && e.target.id === 'nextWeek'){ monday.setDate(monday.getDate()+7); renderWeek(); }
      if (e.target && e.target.id === 'thisWeek'){ monday = getMonday(new Date()); renderWeek(); }
      if (e.target && e.target.id === 'clearWeek'){
        if (!confirm('X√≥a ghi ch√∫ tu·∫ßn n√†y tr√™n THI·∫æT B·ªä N√ÄY?')) return;
        const prefix = `week:${ymd(monday)}:`;
        Object.keys(localStorage).forEach(k=>{ if (k.startsWith(prefix)) localStorage.removeItem(k); });
        renderWeek();
      }
    });

    // Init
    function init(){
      const now = new Date();
      document.getElementById('now').textContent = fmtTime(now);
      document.getElementById('today').textContent = fmtDate(now);
      renderTable();
      renderWeek();
      setInterval(()=>{
        document.getElementById('now').textContent = fmtTime(new Date());
      }, 60*1000);
    }
    window.addEventListener('load', init);
  </script>
</body>
</html>
